<!DOCTYPE>
<html>
  <head>
    <meta charset="utf-8">
    <title>HealthCheck</title>
    <style>
      *{font-family:system-ui;}
      body{background:lightgrey;}
      h1{
        margin: 40px 0;
        text-align:center;
        text-decoration:underline;
      }

      table{
        min-width: 50%;
        margin:auto;
        border-collapse: collapse;
      }
      th{
        text-align:center;
        color: white;
        background: #36304a;
      }
      th:first-child{
        border-top-left-radius: 10px;
      }
      th:last-child{
        border-top-right-radius: 10px;
      }
      tr:last-child td:first-child{
        border-bottom-left-radius: 10px;
      }
      tr:last-child td:last-child{
        border-bottom-right-radius: 10px;
      }
      td, th{
        height: 50px;
        padding: 8px 20px;
      }
      td{
        color: #555555;
        text-align: right;
      }
      td.serv{
        font-weight: bold;
        text-align: center;
      }
      tr{
        background-color: white;
      }
      tr:nth-child(odd) {
        background-color: #f5f5f5;
      }
    </style>
  </head>
  <body>
    <h1>HealthCheck</h1>
    <table id="table">
      <tr>
        <th>Service name</th>
        <th>Service version</th>
        <th>Poetry version</th>
        <th>Uptime</th>
      </tr>
    </table>
    <script type="text/javascript">
      var SERVICE = "%SERVICE%";
      var HEALTHCHECK_PATH = "%HEALTHCHECK_PATH%";
      var services = {};
      var drawing = Date.now();
      services[SERVICE] = 'Loading';

      var table = document.getElementById('table');

      if (HEALTHCHECK_PATH.indexOf('%') > -1) {
        HEALTHCHECK_PATH = ''
      }

      try{
        var request = new XMLHttpRequest();
        request.open("GET", HEALTHCHECK_PATH + '/_healthCheck/'+SERVICE, false);
        request.addEventListener("load", dataReceived(SERVICE));
        request.addEventListener("error", error(SERVICE));
        request.send();
      }catch(e){
        error(SERVICE)(e);
      }

      function dataReceived(service){
        return function(){
          var data;
          try{
            data = JSON.parse(this.responseText);
          }catch(e){
            return error(service)(this.responseText);
          }
          if(!data || data.error) return error(service)(data.error);
          services[service] = data;
          if(data.knownServices)
            data.knownServices.forEach(function(serv){
              if(typeof services[serv] != 'undefined') return;
              services[serv] = 'Loading';
              try{
                var request = new XMLHttpRequest();
                request.open("GET", HEALTHCHECK_PATH + '/_healthCheck/'+serv, false);
                request.addEventListener("load", dataReceived(serv));
                request.addEventListener("error", error(serv));
                request.send();
              }catch(e){
                error(serv)(e);
              }
            });
            draw();
        }
      }
      function error(serv){
        return function(e){
          services[serv] = e.toString();
          draw();
        }
      }
      function draw(){
        var curdrawing = Date.now();
        drawing = curdrawing;

        var prev = document.getElementsByClassName('appended');
        while(prev.length){
          prev.item(0).remove();
        }

        var latestPoetry = Object.keys(services)
          .filter(function(serv){
            return serv && serv.poetry && serv.poetry.version;
          })
          .map(function(serv){
            return serv.poetry.version.split('.');
          })
          .sort(function(a,b){
            if(parseInt(a[0])>parseInt(b[0])) return -1;
            if(parseInt(a[0])<parseInt(b[0])) return 1;
            if(parseInt(a[1])>parseInt(b[1])) return -1;
            if(parseInt(a[1])<parseInt(b[1])) return 1;
            if(parseInt(a[2])>parseInt(b[2])) return -1;
            if(parseInt(a[2])<parseInt(b[2])) return 1;
            return 0;
          })[0];

        Object.keys(services)
          .sort()
          .forEach(function(serv){
            if(drawing != curdrawing) return;
            var row = table.insertRow();
            row.className = 'appended';
            var serviceName = row.insertCell();
            serviceName.className = 'serv';
            serviceName.title = HEALTHCHECK_PATH + '/_healthCheck/'+serv;
            serviceName.ondblclick = function(){
              window.open(this.title,'_tab');
            }
            var serviceVer = row.insertCell();
            write(serviceName, serv);
            if(typeof services[serv] == 'string'){
              write(serviceVer,services[serv]);
              serviceVer.colSpan = 3;
              serviceName.style.color = services[serv]=='Loading'?'lightgray':'lightcoral';
              if(services[serv]=="I'm alive !")
                serviceName.style.color = 'orange';
            }else{
              var poetryVer = row.insertCell();
              var uptime = row.insertCell();
              serviceName.style.color = 'green';
              write(serviceVer,services[serv].service.version);
              var date = services[serv].service.version.split('.');
              date = new Date( 2000+date[0], 0, date[1]).getTime();
              date = Date.now() - date;
              date = Math.floor( date / (24*60*60000) );
              if(date < 1000)
                serviceVer.title = date + ' days ago';
              write(poetryVer,services[serv].poetry.version);
              if(services[serv].poetry.version == latestPoetry)
                poetryVer.style.color = 'green';
              else
                poetryVer.style.color = 'orange';
              write(uptime,toTime(services[serv].uptime));
            }
          });
      }
      function write(cell,text){
        var newText = document.createTextNode(text||'?');
        cell.appendChild(newText);
      }
      function toTime(ms){
        if(!Number.isInteger(ms)) return ms;
        var count = {d:0,h:0,m:0,s:0};
        var value = {
          d: 24*60*60000,
          h: 60*60000,
          m: 60000,
          s: 1000
        }
        while(ms>=value.d){ count.d++; ms -= value.d; }
        while(ms>=value.h){ count.h++; ms -= value.h; }
        while(ms>=value.m){ count.m++; ms -= value.m; }
        count.s = ms / 1000;
        var out = '';
        if(count.d) out += count.d + 'd ';
        if(count.h) out += count.h + 'h ';
        if(count.m) out += count.m + 'm ';
        if(count.s) out += count.s + 's';
        return out;
      }
    </script>
  </body>
</html>
